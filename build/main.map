{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/domain.js","webpack:///./src/emailClients/consoleClient.js","webpack:///./src/emailClients/sendGridClient.js","webpack:///./src/index.js","webpack:///./src/sendMessage.js","webpack:///external \"@sendgrid/mail\"","webpack:///external \"joi\"","webpack:///external \"koa\"","webpack:///external \"koa-body\"","webpack:///external \"koa-router\""],"names":["Attempt","constructor","message","client","error","success","MessageSenderClient","send","Error","ConsoleClient","console","log","SendGrid","setApiKey","process","env","SENDGRID_API_KEY","SendGridClient","sender","recipient","subject","body","to","from","text","html","app","Koa","router","Router","messageSchema","Joi","object","keys","string","required","get","ctx","status","post","schemaResult","validate","request","stripUnknown","details","map","value","attempt","sendMessage","use","KoaBody","routes","allowedMethods","listen","consoleClient","sendGridClient","clients","MaxRetries","DefaultSender","DEFAULT_SENDER","attempts","length","makeAttempt","push","nextTry","name"],"mappings":";;;AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,kDAA0C,gCAAgC;AAC1E;AACA;;AAEA;AACA;AACA;AACA,gEAAwD,kBAAkB;AAC1E;AACA,yDAAiD,cAAc;AAC/D;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iDAAyC,iCAAiC;AAC1E,wHAAgH,mBAAmB,EAAE;AACrI;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;;AAGA;AACA;;;;;;;;;;;;;AClFA;AAAA;AAAA;AAAO,MAAMA,OAAN,CAAc;AACnBC,aAAW,CAACC,OAAD,EAAUC,MAAV,EAAkBC,KAAlB,EAAyB;AAClC,SAAKF,OAAL,GAAeA,OAAf;AACA,SAAKC,MAAL,GAAcA,MAAd;;AAEA,QAAIC,KAAJ,EAAW;AACT,WAAKA,KAAL,GAAaA,KAAb;AACA,WAAKC,OAAL,GAAe,KAAf;AACD,KAHD,MAGO;AACL,WAAKA,OAAL,GAAe,IAAf;AACD;AACF;;AAXkB;AAcd,MAAMC,mBAAN,CAA0B;AAC/BC,MAAI,CAACL,OAAD,EAAU;AACZ,UAAM,IAAIM,KAAJ,CAAU,0BAAV,CAAN;AACD;;AAH8B,C;;;;;;;;;;;;ACdjC;AAAA;AAAA;AAAA;AAEO,MAAMC,aAAN,SAA4BH,2DAA5B,CAAgD;AACrDC,MAAI,CAACL,OAAD,EAAU;AACZQ,WAAO,CAACC,GAAR,CAAY,oBAAZ,EAAkCT,OAAlC;AACD;;AAHoD,C;;;;;;;;;;;;ACFvD;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEAU,qDAAQ,CAACC,SAAT,CAAmB,OAAOC,OAAO,CAACC,GAAR,CAAYC,gBAAtC;AAEO,MAAMC,cAAN,SAA6BX,2DAA7B,CAAiD;AACtDC,MAAI,CAACL,OAAD,EAAU;AACZ,UAAM;AAAEgB,YAAF;AAAUC,eAAV;AAAqBC,aAArB;AAA8BC;AAA9B,QAAuCnB,OAA7C;AACA,WAAOU,qDAAQ,CAACL,IAAT,CAAc;AACnBa,aADmB;AAEnBE,QAAE,EAAEH,SAFe;AAGnBI,UAAI,EAAEL,MAHa;AAInBM,UAAI,EAAEH,IAJa;AAKnBI,UAAI,EAAEJ;AALa,KAAd,CAAP;AAOD;;AAVqD,C;;;;;;;;;;;;ACNxD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AAEA,MAAMK,GAAG,GAAG,IAAIC,0CAAJ,EAAZ;AACA,MAAMC,MAAM,GAAG,IAAIC,iDAAJ,EAAf;AAEA,MAAMC,aAAa,GAAGC,0CAAG,CAACC,MAAJ,GAAaC,IAAb,CAAkB;AACtCf,QAAM,EAAEa,0CAAG,CAACG,MAAJ,EAD8B;AAEtCf,WAAS,EAAEY,0CAAG,CAACG,MAAJ,GAAaC,QAAb,EAF2B;AAGtCf,SAAO,EAAEW,0CAAG,CAACG,MAAJ,GAAaC,QAAb,EAH6B;AAItCd,MAAI,EAAEU,0CAAG,CAACG,MAAJ,GAAaC,QAAb;AAJgC,CAAlB,CAAtB;AAOAP,MAAM,CAACQ,GAAP,CAAW,SAAX,EAAsBC,GAAG,IAAI;AAC3BA,KAAG,CAAChB,IAAJ,GAAW,IAAX;AACAgB,KAAG,CAACC,MAAJ,GAAa,GAAb;AACD,CAHD;AAKAV,MAAM,CAACW,IAAP,CAAY,OAAZ,EAAqB,MAAMF,GAAN,IAAa;AAChC,QAAMG,YAAY,GAAGV,aAAa,CAACW,QAAd,CAAuBJ,GAAG,CAACK,OAAJ,CAAYrB,IAAnC,EAAyC;AAC5DsB,gBAAY,EAAE;AAD8C,GAAzC,CAArB;;AAIA,MAAIH,YAAY,CAACpC,KAAjB,EAAwB;AACtB,UAAM;AAAEwC;AAAF,QAAcJ,YAAY,CAACpC,KAAjC;AACAiC,OAAG,CAAChB,IAAJ,GAAW;AACTjB,WAAK,EAAEwC,OAAO,CAACC,GAAR,CAAY,CAAC;AAAE3C;AAAF,OAAD,KAAiBA,OAA7B;AADE,KAAX;AAGAmC,OAAG,CAACC,MAAJ,GAAa,GAAb;AACA;AACD;;AAED,QAAMpC,OAAO,GAAGsC,YAAY,CAACM,KAA7B;;AAEA,MAAI;AACF,UAAMC,OAAO,GAAG,MAAMC,gEAAW,CAAC9C,OAAD,CAAjC;;AAEA,QAAI,CAAC6C,OAAO,CAAC1C,OAAb,EAAsB;AACpBgC,SAAG,CAAChB,IAAJ,GAAW0B,OAAX;AACAV,SAAG,CAACC,MAAJ,GAAa,GAAb;AACA;AACD;;AAEDD,OAAG,CAAChB,IAAJ,GAAW0B,OAAX;AACAV,OAAG,CAACC,MAAJ,GAAa,GAAb;AACD,GAXD,CAWE,OAAOlC,KAAP,EAAc;AACdiC,OAAG,CAAChB,IAAJ,GAAW;AAAEjB,WAAK,EAAEA,KAAK,CAACF;AAAf,KAAX;AACAmC,OAAG,CAACC,MAAJ,GAAa,GAAb;AACA;AACD;AACF,CAhCD;AAkCAZ,GAAG,CAACuB,GAAJ,CAAQC,+CAAO,EAAf;AACAxB,GAAG,CAACuB,GAAJ,CAAQrB,MAAM,CAACuB,MAAP,EAAR,EAAyBF,GAAzB,CAA6BrB,MAAM,CAACwB,cAAP,EAA7B;AACA1B,GAAG,CAAC2B,MAAJ,CAAW,IAAX,E;;;;;;;;;;;;;;;;;;;;;;AC1DA;AACA;AACA;AAEA,MAAMC,aAAa,GAAG,IAAI7C,yEAAJ,EAAtB;AACA,MAAM8C,cAAc,GAAG,IAAItC,2EAAJ,EAAvB;AAEA,MAAMuC,OAAO,GAAG,CAACD,cAAD,EAAiBD,aAAjB,CAAhB;AACA,MAAMG,UAAU,GAAG,CAAnB;AACA,MAAMC,aAAa,GAAG5C,OAAO,CAACC,GAAR,CAAY4C,cAAZ,IAA8B,yBAApD;AAEO,eAAeX,WAAf,CAA2B9C,OAA3B,EAAoC;AACzC,QAAM0D,QAAQ,GAAG,EAAjB;;AACA,SAAOA,QAAQ,CAACC,MAAT,GAAkBJ,UAAzB,EAAqC;AACnC,UAAMV,OAAO,GAAG,MAAMe,WAAW,mBAE1B5D,OAF0B;AAG7BgB,YAAM,EAAEhB,OAAO,CAACgB,MAAR,IAAkBwC;AAHG,QAK/BE,QAL+B,CAAjC;;AAQA,QAAIb,OAAO,CAAC1C,OAAZ,EAAqB;AACnB,aAAO0C,OAAP;AACD;;AAEDa,YAAQ,CAACG,IAAT,CAAchB,OAAd;AACD;;AAED,SAAO,IAAI/C,+CAAJ,CAAYE,OAAZ,EAAqB,IAArB,EAA2B,sBAA3B,CAAP;AACD;AAEM,eAAe4D,WAAf,CAA2B5D,OAA3B,EAAoC0D,QAApC,EAA8C;AACnD,MAAII,OAAO,GAAG,CAAd;;AACA,MAAIJ,QAAQ,CAACC,MAAb,EAAqB;AACnBG,WAAO,GACLJ,QAAQ,CAACA,QAAQ,CAACC,MAAT,GAAkB,CAAnB,CAAR,CAA8B1D,MAA9B,KAAyCc,2EAAc,CAACgD,IAAxD,GAA+D,CAA/D,GAAmE,CADrE;AAED;;AACD,QAAM9D,MAAM,GAAGqD,OAAO,CAACQ,OAAD,CAAtB;;AAEA,MAAI;AACF,UAAMR,OAAO,CAACQ,OAAD,CAAP,CAAiBzD,IAAjB,CAAsBL,OAAtB,CAAN;AAEA,WAAO,IAAIF,+CAAJ,CAAYE,OAAZ,EAAqBC,MAAM,CAACF,WAAP,CAAmBgE,IAAxC,CAAP;AACD,GAJD,CAIE,OAAO7D,KAAP,EAAc;AACd,WAAO,IAAIJ,+CAAJ,CAAYE,OAAZ,EAAqBC,MAAM,CAACF,WAAP,CAAmBgE,IAAxC,EAA8C7D,KAA9C,CAAP;AACD;AACF,C;;;;;;;;;;;;;;;;;;;;;;;AC/CD,2C;;;;;;;;;;;ACAA,gC;;;;;;;;;;;ACAA,gC;;;;;;;;;;;ACAA,qC;;;;;;;;;;;ACAA,uC","file":"main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","export class Attempt {\n  constructor(message, client, error) {\n    this.message = message;\n    this.client = client;\n\n    if (error) {\n      this.error = error;\n      this.success = false;\n    } else {\n      this.success = true;\n    }\n  }\n}\n\nexport class MessageSenderClient {\n  send(message) {\n    throw new Error('MessageSenderClient.send');\n  }\n}\n","import { MessageSenderClient } from '../domain';\n\nexport class ConsoleClient extends MessageSenderClient {\n  send(message) {\n    console.log('ConsoleClient.send', message);\n  }\n}\n","import SendGrid from '@sendgrid/mail';\n\nimport { MessageSenderClient } from '../domain';\n\nSendGrid.setApiKey('tt' + process.env.SENDGRID_API_KEY);\n\nexport class SendGridClient extends MessageSenderClient {\n  send(message) {\n    const { sender, recipient, subject, body } = message;\n    return SendGrid.send({\n      subject,\n      to: recipient,\n      from: sender,\n      text: body,\n      html: body\n    });\n  }\n}\n","import Koa from 'koa';\nimport KoaBody from 'koa-body';\nimport Router from 'koa-router';\nimport Joi from 'joi';\n\nimport { sendMessage } from './sendMessage';\n\nconst app = new Koa();\nconst router = new Router();\n\nconst messageSchema = Joi.object().keys({\n  sender: Joi.string(),\n  recipient: Joi.string().required(),\n  subject: Joi.string().required(),\n  body: Joi.string().required()\n});\n\nrouter.get('/health', ctx => {\n  ctx.body = 'OK';\n  ctx.status = 200;\n});\n\nrouter.post('/send', async ctx => {\n  const schemaResult = messageSchema.validate(ctx.request.body, {\n    stripUnknown: true\n  });\n\n  if (schemaResult.error) {\n    const { details } = schemaResult.error;\n    ctx.body = {\n      error: details.map(({ message }) => message)\n    };\n    ctx.status = 400;\n    return;\n  }\n\n  const message = schemaResult.value;\n\n  try {\n    const attempt = await sendMessage(message);\n\n    if (!attempt.success) {\n      ctx.body = attempt;\n      ctx.status = 500;\n      return;\n    }\n\n    ctx.body = attempt;\n    ctx.status = 200;\n  } catch (error) {\n    ctx.body = { error: error.message };\n    ctx.status = 500;\n    return;\n  }\n});\n\napp.use(KoaBody());\napp.use(router.routes()).use(router.allowedMethods());\napp.listen(3000);\n","import { Attempt } from './domain';\nimport { ConsoleClient } from './emailClients/consoleClient';\nimport { SendGridClient } from './emailClients/sendGridClient';\n\nconst consoleClient = new ConsoleClient();\nconst sendGridClient = new SendGridClient();\n\nconst clients = [sendGridClient, consoleClient];\nconst MaxRetries = 3;\nconst DefaultSender = process.env.DEFAULT_SENDER || 'matyas.buczko@gmail.com';\n\nexport async function sendMessage(message) {\n  const attempts = [];\n  while (attempts.length < MaxRetries) {\n    const attempt = await makeAttempt(\n      {\n        ...message,\n        sender: message.sender || DefaultSender\n      },\n      attempts\n    );\n\n    if (attempt.success) {\n      return attempt;\n    }\n\n    attempts.push(attempt);\n  }\n\n  return new Attempt(message, null, 'Max retries exceeded');\n}\n\nexport async function makeAttempt(message, attempts) {\n  let nextTry = 0;\n  if (attempts.length) {\n    nextTry =\n      attempts[attempts.length - 1].client === SendGridClient.name ? 1 : 0;\n  }\n  const client = clients[nextTry];\n\n  try {\n    await clients[nextTry].send(message);\n\n    return new Attempt(message, client.constructor.name);\n  } catch (error) {\n    return new Attempt(message, client.constructor.name, error);\n  }\n}\n","module.exports = require(\"@sendgrid/mail\");","module.exports = require(\"joi\");","module.exports = require(\"koa\");","module.exports = require(\"koa-body\");","module.exports = require(\"koa-router\");"],"sourceRoot":""}